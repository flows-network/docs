"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[657],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>u});var o=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,o,r=function(e,t){if(null==e)return{};var n,o,r={},a=Object.keys(e);for(o=0;o<a.length;o++)n=a[o],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(o=0;o<a.length;o++)n=a[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=o.createContext({}),c=function(e){var t=o.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},d=function(e){var t=c(e.components);return o.createElement(l.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},h=o.forwardRef((function(e,t){var n=e.components,r=e.mdxType,a=e.originalType,l=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),h=c(n),u=r,m=h["".concat(l,".").concat(u)]||h[u]||p[u]||a;return n?o.createElement(m,i(i({ref:t},d),{},{components:n})):o.createElement(m,i({ref:t},d))}));function u(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var a=n.length,i=new Array(a);i[0]=h;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:r,i[1]=s;for(var c=2;c<a;c++)i[c]=n[c];return o.createElement.apply(null,i)}return o.createElement.apply(null,n)}h.displayName="MDXCreateElement"},3240:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>p,frontMatter:()=>a,metadata:()=>s,toc:()=>c});var o=n(7462),r=(n(7294),n(3905));const a={sidebar_position:3},i="A Discord bot powered by ChatGPT",s={unversionedId:"getting-started-developer/discord-chatgpt",id:"getting-started-developer/discord-chatgpt",title:"A Discord bot powered by ChatGPT",description:"In this article, I will show you how to create a flow function that incorporates ChatGPT services. This flow function is a Discord bot.",source:"@site/docs/getting-started-developer/discord-chatgpt.md",sourceDirName:"getting-started-developer",slug:"/getting-started-developer/discord-chatgpt",permalink:"/docs/getting-started-developer/discord-chatgpt",draft:!1,editUrl:"https://github.com/flows-network/docs/tree/main/docs/getting-started-developer/discord-chatgpt.md",tags:[],version:"current",sidebarPosition:3,frontMatter:{sidebar_position:3},sidebar:"tutorialSidebar",previous:{title:"A Hello World Discord bot",permalink:"/docs/getting-started-developer/hello-world-discord"},next:{title:"Object Detection (web)",permalink:"/docs/getting-started-developer/object-detection"}},l={},c=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Prepare the source code",id:"prepare-the-source-code",level:2},{value:"Import and build",id:"import-and-build",level:2},{value:"Configure the OpenAI API key",id:"configure-the-openai-api-key",level:2},{value:"Deploy",id:"deploy",level:2},{value:"Test it!",id:"test-it",level:2},{value:"Code walkthrough",id:"code-walkthrough",level:2}],d={toc:c};function p(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,o.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"a-discord-bot-powered-by-chatgpt"},"A Discord bot powered by ChatGPT"),(0,r.kt)("p",null,"In this article, I will show you how to create a flow function that incorporates ChatGPT services. This flow function is a Discord bot.\nYou can chat with it in a conversation. All the bot answers come from ChatGPT. You can change the ChatGPT prompt in the bot's source code\nfor the bot to take on different personalities. "),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"You can also ",(0,r.kt)("a",{parentName:"p",href:"../getting-started-template/discord-chatgpt"},"create the Discord bot through a flow template"),". The template is an easy-to-use no-code solution, but it is also less flexible.")),(0,r.kt)("h2",{id:"prerequisites"},"Prerequisites"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"A GitHub account to log into the ",(0,r.kt)("a",{parentName:"li",href:"https://flows.network/"},"flows.network")," platform. It's free."),(0,r.kt)("li",{parentName:"ol"},"A Discord server that you have permission to add a bot."),(0,r.kt)("li",{parentName:"ol"},"An OpenAI API key.")),(0,r.kt)("h2",{id:"prepare-the-source-code"},"Prepare the source code"),(0,r.kt)("p",null,"For this tutorial, we already created ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/flows-network/discord-chatgpt/"},"a repo named ",(0,r.kt)("inlineCode",{parentName:"a"},"discord-gpt"))," for you to fork."),(0,r.kt)("h2",{id:"import-and-build"},"Import and build"),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://flows.network/flow/new"},"Click here")," to import your forked source code repo for the flow function into flows.network."),(0,r.kt)("p",null,"For this flow function, we need to add a Discord token in settings so that it can listen for messages from a specific Discord bot.\nPlease refer to ",(0,r.kt)("a",{parentName:"p",href:"https://flows.network/blog/discord-chat-bot-guide"},"How to create a Discord chat bot")," on how to get your Discord token.\nClick on the ",(0,r.kt)("strong",{parentName:"p"},"Advanced")," link to configure the settings."),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Name"),(0,r.kt)("th",{parentName:"tr",align:null},"Value"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"discord_token"),(0,r.kt)("td",{parentName:"tr",align:null},"Copied from Discord Developer Portal")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"placeholder_text"),(0,r.kt)("td",{parentName:"tr",align:null},'Optional: The "wait" message displayed to the user while the bot waits for ChatGPT replies')),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"system_prompt"),(0,r.kt)("td",{parentName:"tr",align:null},"Optional: The system level prompt that sets the context for the entire conversation")))),(0,r.kt)("p",null,"Click on the ",(0,r.kt)("strong",{parentName:"p"},"Build")," button to create the flow funtion."),(0,r.kt)("p",null,"In the next screen, you will be asked to connect to Discord. Since we are providing a Discord API token to access the bot here, you can\nsimply click on ",(0,r.kt)("strong",{parentName:"p"},"Continue"),"."),(0,r.kt)("h2",{id:"configure-the-openai-api-key"},"Configure the OpenAI API key"),(0,r.kt)("p",null,"Enter your OpenAI API key on the next screen. You can have multiple keys and give each of them a name. You can\nthen access the keys by their names through the OpenAI SDK in the flow function."),(0,r.kt)("h2",{id:"deploy"},"Deploy"),(0,r.kt)("p",null,"Finally, you will be redirected to the flow details page, where you can check for\nservice status and logs.\nDiscord and OpenAI should appear as connected external services on this page."),(0,r.kt)("h2",{id:"test-it"},"Test it!"),(0,r.kt)("p",null,"When the status of the flow is ready and running, you can invite the Discord bot to your sever."),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"Refer to this guide to ",(0,r.kt)("a",{parentName:"p",href:"https://flows.network/blog/discord-chat-bot-guide"},"invite the bot to your server"),".")),(0,r.kt)("p",null,"After the bot joined your server, you can find the bot on the right contact list and DM the bot. The bot will chat with you now!"),(0,r.kt)("h2",{id:"code-walkthrough"},"Code walkthrough"),(0,r.kt)("p",null,"The source code for the flow function is written in the Rust programming language.\nThe ",(0,r.kt)("inlineCode",{parentName:"p"},"on_deploy()")," function is called by the flows.network platform when the flow is deployed. We start a listener for\nthe designated bot in ",(0,r.kt)("inlineCode",{parentName:"p"},"on_deploy()"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-rust"},'pub async fn on_deploy() {\n    let token = std::env::var("discord_token").unwrap();\n    let bot = ProvidedBot::new(token);\n    bot.listen_to_messages().await;\n}\n')),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"handler()")," function is annotated with ",(0,r.kt)("inlineCode",{parentName:"p"},"#[message_handler]"),". It is called when the bot receives a message. We first sends\nthe placeholder message back to the user asking him to wait.\nNote that ",(0,r.kt)("inlineCode",{parentName:"p"},"channel_id")," uniquely identifies the Discord conversation for this bot message\nas the bot can be in multiple conversations at the same time."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-rust"},'#[message_handler]\nasync fn handler(msg: Message) {\n    let token = env::var("discord_token").unwrap();\n    let placeholder_text = &env::var("placeholder").unwrap_or("Typing ...".to_string());\n    let system_prompt = &env::var("system_prompt").unwrap_or("You are a helpful assistant answering questions on Discord.".to_string());\n\n    let bot = ProvidedBot::new(token);\n    let discord = bot.get_client();\n\n    let channel_id = msg.channel_id;\n    let content = msg.content;\n\n    let placeholder  = discord.send_message(\n        channel_id.into(),\n        &serde_json::json!({\n            "content": placeholder_text\n        }),\n    ).await.unwrap();\n')),(0,r.kt)("p",null,"Next, it detects if the message is ",(0,r.kt)("inlineCode",{parentName:"p"},"/restart")," command. For this command, it will set a flag in a KV store provided by the\nflows.network platform. The flow function can access the KV store using the ",(0,r.kt)("inlineCode",{parentName:"p"},"store"),' API in the SDK.\nWhen the flag is set, the flow function knows to "restart" the conversation when it is triggered the next time.\nThat is, it will start a new conversation when the user sends in a new message after ',(0,r.kt)("inlineCode",{parentName:"p"},"/restart"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-rust"},'    if content.eq_ignore_ascii_case("/restart") {\n        _ = discord.send_message(\n            channel_id.into(),\n            &serde_json::json!({\n                "content": "Ok, I am starting a new conversation."\n            }),\n        ).await;\n        store::set(&channel_id.to_string(), json!(true), None);\n        return;\n    }\n')),(0,r.kt)("p",null,"Then, we send the bot message ChatGPT via the OpenAI SDK. Once we receive a reply, we will replace the placeholder message\nwith the actual reply. Note that the OpenAI SDK automatically caches the conversation history,\nincluding the ",(0,r.kt)("inlineCode",{parentName:"p"},"system_prompt")," at the beginning, so that you do not need to replay the entire conversation at every request.\nThe conversation history is cached under the key ",(0,r.kt)("inlineCode",{parentName:"p"},"channel_id"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-rust"},'    let mut openai = OpenAIFlows::new();\n    openai.set_retry_times(3);\n    let co = ChatOptions {\n        model: ChatModel::GPT35Turbo,\n        restart: restart,\n        system_prompt: Some(system_prompt),\n        ..Default::default()\n    };\n\n    match openai.chat_completion(&channel_id.to_string(), &content, &co).await {\n        Ok(r) => {\n            _ = discord.edit_message(\n                channel_id.into(), placeholder.id.into(),\n                &serde_json::json!({\n                    "content": r.choice\n                }),\n            ).await;\n        }\n    }\n}\n')),(0,r.kt)("p",null,"As you can see, the flow function gives you fine-grained control over the interactions between Discord and ChatGPT\nso that you can deliver a fully customized experience for your bot users."))}p.isMDXComponent=!0}}]);